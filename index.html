<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Open Source Book Finder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
    tailwind.config = {
        darkMode: "class",
    };
    </script>
    <style>
      /* line-clamp simple (cross-browser modern) */
      .lc-2 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
      }
      .lc-3 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
      }
      /* ensure img covers and card equal heights */
      .card-min {
        min-height: 420px;
      }
      /* badge small */
      .badge {
        position: absolute;
        left: 0.6rem;
        top: 0.6rem;
        z-index: 10;
      }
    </style>
  </head>
  <body
    class="bg-gray-50 dark:bg-gray-900 transition-colors text-gray-900 dark:text-gray-100"
  >
    <div class="max-w-6xl mx-auto p-4 md:p-6">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <!-- book-open heroicon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-8 w-8 text-blue-700 dark:text-blue-400"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden
          >
            <path
              d="M12 20.5c-3.2-1.7-6-1.7-8.5 0V6.5A2 2 0 015.5 4.5h13a2 2 0 012 2v14c-2.5-1.7-5.3-1.7-8.5 0"
            ></path>
            <path d="M3 6.5a2 2 0 012-2h13" opacity="0.8"></path>
          </svg>
          <h1 class="text-2xl md:text-3xl font-bold">
            Open Source Book Finder
          </h1>
        </div>

        <!-- Theme toggle -->
        <button
          id="toggleTheme"
          aria-label="Toggle theme"
          class="flex items-center gap-2 px-3 py-2 rounded-lg border bg-gray-100 dark:bg-gray-800 dark:border-gray-700"
        >
          <!-- icon + label filled by JS -->
        </button>
      </div>

      <!-- Search -->
      <form
        id="searchForm"
        class="flex flex-col sm:flex-row gap-3 mb-6  overflow-hidden"
      >
        <label for="searchInput" class="sr-only">Cari buku</label>
        <input 
          id="searchInput"
          name="q"
          type="search"
          autocomplete="off"
          placeholder="Cari judul, pengarang, ISBN..."
          class="flex-grow p-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:outline-none shadow rounded-xl"
        />
        <button
          type="submit"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 flex items-center gap-2 rounded-xl"
        >
          <!-- magnifying-glass heroicon -->
          <svg
            xmlns="http://www.w3.org/2000/svg"
            class="h-5 w-5"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round"
            stroke-linejoin="round"
            aria-hidden
          >
            <path d="M21 21l-4.35-4.35"></path>
            <circle cx="11" cy="11" r="6"></circle>
          </svg>
          Cari
        </button>
      </form>

      <!-- Results -->
      <div
        id="results"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
      ></div>
    </div>

    <script>
      // --- constants ---
      const FALLBACK_IMG =
        "https://www.creativefabrica.com/wp-content/uploads/2020/12/29/Line-File-Not-Found-Icon-Office-Graphics-7428373-1-1-580x387.jpg";

      // Heroicon SVG pieces (using simple hero-style paths). We'll inject strings where needed.
      const ICONS = {
        sun: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden>
              <circle cx="12" cy="12" r="4"></circle>
              <path d="M12 2v2M12 20v2M4.9 4.9l1.4 1.4M17.7 17.7l1.4 1.4M2 12h2M20 12h2M4.9 19.1l1.4-1.4M17.7 6.3l1.4-1.4"></path>
            </svg>`,
        moon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden>
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
            </svg>`,
        book: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden>
              <path d="M4 19.5A2.5 2.5 0 016.5 17H20"></path>
              <path d="M20 4.5H6.5A2.5 2.5 0 004 7v10"></path>
            </svg>`,
        user: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden>
              <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>`,
        calendar: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden>
                   <rect x="3" y="5" width="18" height="16" rx="2"></rect>
                   <path d="M16 3v4M8 3v4M3 11h18"></path>
                 </svg>`,
        lock: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden>
              <rect x="3" y="11" width="18" height="11" rx="2"></rect>
              <path d="M7 11V7a5 5 0 0110 0v4"></path>
            </svg>`,
        tag: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden>
              <path d="M20.59 13.41L11 3 3 11l8.59 8.59a2 2 0 002.83 0l6.17-6.17a2 2 0 000-2.83z"></path>
              <circle cx="7.5" cy="7.5" r="1.5"></circle>
            </svg>`,
        read: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round" aria-hidden>
              <path d="M12 20l9-5-9-5-9 5 9 5z"></path>
              <path d="M12 12V4"></path>
            </svg>`,
        gift: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline-block" 
            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" 
            stroke-linecap="round" stroke-linejoin="round" aria-hidden>
            <rect x="3" y="8" width="18" height="13" rx="2"></rect>
            <path d="M12 8v13M8 8a4 4 0 118-4c0 2-4 4-4 4s-4-2-4-4 4-4 4-4"></path>
            </svg>`,
      };

      // --- theme management ---
      window.addEventListener('DOMContentLoaded', () => {
        const toggleBtn = document.getElementById('toggleTheme');

        function applyTheme(isDark) {
            if (isDark) {
            document.documentElement.classList.add('dark');
            toggleBtn.innerHTML = ICONS.sun + '<span class="ml-1">Light</span>';
            } else {
            document.documentElement.classList.remove('dark');
            toggleBtn.innerHTML = ICONS.moon + '<span class="ml-1">Dark</span>';
            }
            localStorage.setItem('osbf-theme-dark', isDark ? '1' : '0');
        }

        const saved = localStorage.getItem('osbf-theme-dark');
        applyTheme(saved === '1' || (!saved && window.matchMedia('(prefers-color-scheme: dark)').matches));

        toggleBtn.addEventListener('click', () => {
            const isDark = !document.documentElement.classList.contains('dark');
            applyTheme(isDark);
        });
        });


      // --- search logic ---
      const resultsDiv = document.getElementById("results");
      async function searchBooks() {
        const query = (
          document.getElementById("searchInput").value || ""
        ).trim();
        if (!query) {
          resultsDiv.innerHTML = `<p class="text-gray-600 dark:text-gray-300">Masukkan kata kunci pencarian terlebih dahulu.</p>`;
          return;
        }
        resultsDiv.innerHTML = `<p class="text-gray-600 dark:text-gray-400">Mencari &hellip;</p>`;

        try {
          const res = await fetch(
            `https://openlibrary.org/search.json?q=${encodeURIComponent(
              query
            )}&limit=24`
          );
          if (!res.ok) throw new Error("Network response not ok");
          const data = await res.json();
          const docs = data.docs || [];
          if (docs.length === 0) {
            resultsDiv.innerHTML = `<p class="text-red-600 dark:text-red-400">Buku tidak ditemukan.</p>`;
            return;
          }

          // build cards
          resultsDiv.innerHTML = "";
          docs.slice(0, 24).forEach((doc) => {
            const title = doc.title ?? "Tanpa Judul";
            const author =
              (doc.author_name && doc.author_name.join(", ")) ??
              "Tidak diketahui";
            const year = doc.first_publish_year ?? "â€”";
            const coverId = doc.cover_i;
            const coverUrl = coverId
              ? `https://covers.openlibrary.org/b/id/${coverId}-L.jpg`
              : FALLBACK_IMG;

            // description/snippet
            let snippet = "";
            if (doc.first_sentence) {
              if (typeof doc.first_sentence === "string")
                snippet = doc.first_sentence;
              else if (Array.isArray(doc.first_sentence))
                snippet = doc.first_sentence[0];
              else if (doc.first_sentence.value)
                snippet = doc.first_sentence.value;
            } else if (doc.subtitle) snippet = doc.subtitle;
            // sanitize snippet simple (strip newlines)
            snippet = (snippet || "").toString().replace(/\s+/g, " ").trim();

            // status logic
            let status = "need-access"; // default LOCATE
            if (doc.public_scan_b) status = "free";
            else if ((doc.ebook_count_i ?? 0) > 0) status = "borrow";

            // badges and button
            let badgeHtml = "";
            let btnHtml = "";
            const workUrl = `https://openlibrary.org${doc.key || ""}`;

            if (status === "free") {
              badgeHtml = `<span class="badge bg-green-600 text-white px-3 py-1.5 rounded-full text-sm inline-flex items-center gap-2 shadow whitespace-nowrap">
                ${ICONS.gift}<span class="font-medium">Free</span>
            </span>`;

              btnHtml = `<a href="${workUrl}" target="_blank" rel="noopener" aria-label="Baca sekarang" class="mt-3 inline-flex items-center gap-2 justify-center bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg">${ICONS.read}<span>Baca Sekarang</span></a>`;
            } else if (status === "borrow") {
              badgeHtml = `<span class="badge bg-blue-600 text-white px-2 py-1 rounded-full text-xs flex items-center gap-1 shadow">${ICONS.tag}<span class="font-medium">Borrow</span></span>`;
              // still allow visit/read link (Open Library will prompt login/borrow)
              btnHtml = `<a href="${workUrl}" target="_blank" rel="noopener" aria-label="Baca (requires borrow/login)" class="mt-3 inline-flex items-center gap-2 justify-center bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg">${ICONS.read}<span>Baca Sekarang</span></a>`;
            } else {
              badgeHtml = `<span class="badge bg-gray-600 text-white px-3 py-1.5 rounded-full text-sm inline-flex items-center gap-2 shadow whitespace-nowrap">
                ${ICONS.lock}<span class="font-medium">Need Access</span>
            </span>`;

              btnHtml = `<a href="${workUrl}" target="_blank" rel="noopener" aria-label="Need Access" class="mt-3 inline-flex items-center gap-2 justify-center bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg">${ICONS.lock}<span>Need Access</span></a>`;
            }

            // card markup
            const card = document.createElement("article");
            card.className =
              "bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden flex flex-col card-min h-full hover:shadow-xl transition-shadow relative";

            // image wrapper with gradient overlay
            const imgWrap = document.createElement("div");
            imgWrap.className = "relative";
            imgWrap.style.minHeight = "14rem";

            const img = document.createElement("img");
            img.className = "w-full h-56 object-cover";
            img.src = coverUrl;
            img.alt = title;
            img.loading = "lazy";
            img.onerror = function () {
              this.onerror = null;
              this.src = FALLBACK_IMG;
            };

            // gradient overlay to make title readable (subtle)
            const overlay = document.createElement("div");
            overlay.className =
              "absolute inset-0 bg-gradient-to-t from-black/40 to-transparent pointer-events-none";

            imgWrap.appendChild(img);
            imgWrap.appendChild(overlay);

            // append badge (use innerHTML)
            const badgeContainer = document.createElement("div");
            badgeContainer.className = "absolute z-20";
            badgeContainer.style.left = "0.6rem";
            badgeContainer.style.top = "0.6rem";
            badgeContainer.innerHTML = badgeHtml;

            // content
            const content = document.createElement("div");
            content.className = "p-4 flex flex-col flex-grow";

            // title
            const h2 = document.createElement("h2");
            h2.className =
              "text-lg font-semibold text-gray-900 dark:text-gray-100 lc-2";
            h2.textContent = title;

            // author line
            const pAuthor = document.createElement("p");
            pAuthor.className =
              "text-gray-600 dark:text-gray-300 text-sm mt-2 flex items-center gap-2 lc-2";
            pAuthor.innerHTML = `${ICONS.user}<span class="truncate">${author}</span>`;

            // year line
            const pYear = document.createElement("p");
            pYear.className =
              "text-gray-500 dark:text-gray-400 text-sm mt-1 flex items-center gap-2";
            pYear.innerHTML = `${ICONS.calendar}<span>${year}</span>`;

            // snippet
            const pSnippet = document.createElement("p");
            pSnippet.className =
              "text-gray-700 dark:text-gray-200 text-sm mt-2 lc-3";
            pSnippet.textContent = snippet || "";

            // actions (button)
            const actionWrap = document.createElement("div");
            actionWrap.className = "mt-auto";

            actionWrap.innerHTML = btnHtml;

            // assemble
            card.appendChild(imgWrap);
            card.appendChild(badgeContainer);
            content.appendChild(h2);
            content.appendChild(pAuthor);
            content.appendChild(pYear);
            if (snippet) content.appendChild(pSnippet);
            content.appendChild(actionWrap);
            card.appendChild(content);
            resultsDiv.appendChild(card);
          });
        } catch (err) {
          console.error(err);
          resultsDiv.innerHTML = `<p class="text-red-600 dark:text-red-400">Terjadi kesalahan ketika mengambil data.</p>`;
        }
      }

      // wire form submit (ENTER works)
      document.getElementById("searchForm").addEventListener("submit", (e) => {
        e.preventDefault();
        searchBooks();
      });

      // optional: run example search on load (comment out if not wanted)
      // document.getElementById('searchInput').value = 'harry potter';
      // searchBooks();
    </script>
  </body>
</html>
