<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Open Source Book Finder</title>
    <link
      rel="icon"
      type="image/png"
      href="https://cdn-icons-png.flaticon.com/512/29/29302.png"
    />

    <link rel="stylesheet"   href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = { darkMode: "class" };
    </script>
    <style>
      .lc-2 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 2;
      }
      .lc-3 {
        overflow: hidden;
        display: -webkit-box;
        -webkit-box-orient: vertical;
        -webkit-line-clamp: 3;
      }
      .card-min {
        min-height: 420px;
      }
      .badge {
        position: absolute;
        left: 0.6rem;
        top: 0.6rem;
        z-index: 10;
      }
    </style>
  </head>
  <body
    class="bg-gray-50 dark:bg-gray-900 transition-colors text-gray-900 dark:text-gray-100"
  >
    <div class="max-w-6xl mx-auto p-4 md:p-6">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <h1 class="text-2xl md:text-3xl font-bold">Open Source Book Finder</h1>
        </div>


        
        <!-- Theme toggle -->
        <button
          id="toggleTheme"
          aria-label="Toggle theme"
          class="flex items-center gap-2 px-3 py-2 rounded-lg border bg-gray-100 dark:bg-gray-800 dark:border-gray-700"
        ></button>
      </div>

      <!-- Search -->
      <form
        id="searchForm"
        class="flex flex-col sm:flex-row gap-3 mb-6 overflow-hidden"
      >
        <label for="searchInput" class="sr-only">Cari buku</label>
        <input
          id="searchInput"
          type="search"
          autocomplete="off"
          placeholder="Cari judul, pengarang, ISBN..."
          class="flex-grow p-3 border border-gray-300 dark:border-gray-700 bg-white dark:bg-gray-800 focus:outline-none shadow rounded-xl"
        />
        <button
          type="submit"
          class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-3 flex items-center gap-2 rounded-xl"
        >
         <i class="bi bi-search"></i> Cari
        </button>
      </form>

      <!-- Results -->
      <div
        id="results"
        class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
      ></div>
    </div>

    <!-- Modal -->
    <div
      id="readModal"
      class="fixed inset-0 hidden items-center justify-center bg-black/60 z-50"
    >
      <div
        class="bg-white dark:bg-gray-800 rounded-2xl shadow-xl p-6 w-80 text-center"
      >
        <h2 class="text-lg font-semibold mb-4">Mau baca langsung?</h2>
        <div class="flex flex-col gap-3">
          <a
            id="btnReadNow"
            href="#"
            target="_blank"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
          >
            <i class="bi bi-book-half"></i> Baca Langsung
          </a>
          <a
            id="btnViewProfile"
            href="#"
            target="_blank"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
          >
            <i class="bi bi-info-circle"></i> Lihat Detail Buku
          </a>
          <button
            onclick="closeModal()"
            class="bg-red-700 hover:bg-red-800 text-white px-4 py-2 rounded-lg"
          >
             <i class="bi bi-x-circle"></i> Batal
          </button>
        </div>
      </div>
    </div>

    <script>

        // --- Dark mode toggle ---
const toggleBtn = document.getElementById("toggleTheme");

function setTheme(dark) {
  if (dark) {
    document.documentElement.classList.add("dark");
    localStorage.setItem("theme", "dark");
    toggleBtn.innerHTML = `<i class="bi bi-moon"></i> <span>Dark</span>`;
  } else {
    document.documentElement.classList.remove("dark");
    localStorage.setItem("theme", "light");
    toggleBtn.innerHTML = `<i class="bi bi-sun"></i> <span>Light</span>`;
    // toggleBtn.innerHTML = "☀️ Light";
  }
}

// cek preferensi awal
const savedTheme = localStorage.getItem("theme");
if (savedTheme === "dark" || (!savedTheme && window.matchMedia("(prefers-color-scheme: dark)").matches)) {
  setTheme(true);
} else {
  setTheme(false);
}

// klik tombol ganti tema
toggleBtn.addEventListener("click", () => {
  const isDark = document.documentElement.classList.contains("dark");
  setTheme(!isDark);
});

      let allDocs = [];
      let currentPage = 1;
      const pageSize = 24;
      const resultsDiv = document.getElementById("results");

      const FALLBACK_IMG =
        "https://www.creativefabrica.com/wp-content/uploads/2020/12/29/Line-File-Not-Found-Icon-Office-Graphics-7428373-1-1-580x387.jpg";

      // --- Modal ---
      function openModal(readUrl, workUrl) {
        document.getElementById("btnReadNow").href = readUrl;
        document.getElementById("btnViewProfile").href = workUrl;
        document.getElementById("readModal").classList.remove("hidden");
        document.getElementById("readModal").classList.add("flex");
      }
      function closeModal() {
        document.getElementById("readModal").classList.remove("flex");
        document.getElementById("readModal").classList.add("hidden");
      }

      // --- Search ---
      async function searchBooks() {
        const query = (document.getElementById("searchInput").value || "").trim();
        if (!query) {
          resultsDiv.innerHTML =
            "<p class='text-gray-600 dark:text-gray-300'>Masukkan kata kunci pencarian terlebih dahulu.</p>";
          return;
        }
        resultsDiv.innerHTML =
          "<p class='text-gray-600 dark:text-gray-400'>Mencari…</p>";

        try {
          const res = await fetch(
            `https://openlibrary.org/search.json?q=${encodeURIComponent(query)}`
          );
          if (!res.ok) throw new Error("Network response not ok");
          const data = await res.json();

          allDocs = data.docs || [];
          currentPage = 1;
          renderPage();
        } catch (err) {
          console.error(err);
          resultsDiv.innerHTML =
            "<p class='text-red-600 dark:text-red-400'>Terjadi kesalahan ketika mengambil data.</p>";
        }
      }

      function renderPage() {
        resultsDiv.innerHTML = "";
        const start = (currentPage - 1) * pageSize;
        const end = start + pageSize;
        const pageDocs = allDocs.slice(start, end);

        pageDocs.forEach((doc) => {
          const title = doc.title ?? "Tanpa Judul";
          const author =
            (doc.author_name && doc.author_name.join(", ")) ?? "Tidak diketahui";
          const year = doc.first_publish_year ?? "—";
          const coverId = doc.cover_i;
          const coverUrl = coverId
            ? `https://covers.openlibrary.org/b/id/${coverId}-L.jpg`
            : FALLBACK_IMG;

          let snippet = "";
          if (doc.first_sentence) {
            if (typeof doc.first_sentence === "string") snippet = doc.first_sentence;
            else if (Array.isArray(doc.first_sentence))
              snippet = doc.first_sentence[0];
            else if (doc.first_sentence.value) snippet = doc.first_sentence.value;
          } else if (doc.subtitle) snippet = doc.subtitle;
          snippet = (snippet || "").toString().replace(/\s+/g, " ").trim();

          let status = "need-access";
          if (doc.public_scan_b) status = "free";
          else if ((doc.ebook_count_i ?? 0) > 0) status = "borrow";

          const workUrl = `https://openlibrary.org${doc.key || ""}`;
          const editionKey = (doc.edition_key && doc.edition_key[0]) || null;
          const ocaid = doc.ia && doc.ia.length > 0 ? doc.ia[0] : null;
          const readUrl = ocaid
            ? `https://archive.org/details/${ocaid}?view=theater`
            : editionKey
            ? `https://openlibrary.org/stream/${editionKey}`
            : workUrl;

          let badgeHtml = "";
          let btnHtml = "";
          if (status === "free") {
            badgeHtml = `<span class="badge bg-green-600 text-white px-3 py-1.5 rounded-full text-sm">Free</span>`;
            btnHtml = `<button onclick="openModal('${readUrl}','${workUrl}')" 
              class="mt-3 bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-lg"><i class="bi bi-book"></i> Baca Sekarang</button>`;
          } else if (status === "borrow") {
            badgeHtml = `<span class="badge bg-blue-600 text-white px-3 py-1.5 rounded-full text-sm">Borrow</span>`;
            btnHtml = `<button onclick="openModal('${readUrl}','${workUrl}')" 
              class="mt-3 bg-blue-600 hover:bg-blue-700 text-white px-3 py-2 rounded-lg"><i class="bi bi-book"></i>Baca Sekarang</button>`;
          } else {
            badgeHtml = `<span class="badge bg-gray-600 text-white px-3 py-1.5 rounded-full text-sm"><i class="bi bi-shield-lock"></i> Need Access</span>`;
            btnHtml = `<button href="${workUrl}" target="_blank" class="mt-3 bg-gray-600 hover:bg-gray-700 text-white px-3 py-2 rounded-lg"> <i class="bi bi-shield-lock"></i>   Need Access</button>`;
          }

          const card = document.createElement("article");
          card.className =
            "bg-white dark:bg-gray-800 rounded-xl shadow-md overflow-hidden flex flex-col card-min hover:shadow-xl transition-shadow relative";

          const img = document.createElement("img");
          img.className = "w-full h-56 object-cover";
          img.src = coverUrl;
          img.alt = title;
          img.onerror = () => (img.src = FALLBACK_IMG);

          const badgeContainer = document.createElement("div");
          badgeContainer.innerHTML = badgeHtml;

          const content = document.createElement("div");
          content.className = "p-4 flex flex-col flex-grow";
          content.innerHTML = `
            <h2 class="text-lg font-semibold lc-2">${title}</h2>
            <p class="text-sm text-gray-600">${author}</p>
            <p class="text-sm text-gray-500">${year}</p>
            <p class="text-sm mt-2 lc-3">${snippet}</p>
            <div class="mt-auto">${btnHtml}</div>
          `;

          card.appendChild(img);
          card.appendChild(badgeContainer);
          card.appendChild(content);
          resultsDiv.appendChild(card);
        });

        // Pagination buttons
        const totalPages = Math.ceil(allDocs.length / pageSize);
        if (totalPages > 1) {
          const nav = document.createElement("div");
          nav.className = "flex justify-center gap-4 mt-6 col-span-full";

          if (currentPage > 1) {
            const prevBtn = document.createElement("button");
            prevBtn.textContent = "⬅️ Prev";
            prevBtn.className =
              "px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg";
            prevBtn.onclick = () => {
              currentPage--;
              renderPage();
            };
            nav.appendChild(prevBtn);
          }

          if (currentPage < totalPages) {
            const nextBtn = document.createElement("button");
            nextBtn.textContent = "Next ➡️";
            nextBtn.className =
              "px-4 py-2 bg-gray-300 dark:bg-gray-700 rounded-lg";
            nextBtn.onclick = () => {
              currentPage++;
              renderPage();
            };
            nav.appendChild(nextBtn);
          }

          resultsDiv.appendChild(nav);
        }
      }

      document
        .getElementById("searchForm")
        .addEventListener("submit", (e) => {
          e.preventDefault();
          searchBooks();
        });
    </script>
  </body>
</html>
